<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.O.G. | THE MINISTRY OF GROOVE HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --mog-gold: #D4AF37; --mog-blue: #00d4ff; --mog-black: #050505; --mog-red: #ff3333; }
        * { transition: all 0.25s ease; scroll-behavior: smooth; }
        body { font-family: 'JetBrains+Mono', monospace; background-color: var(--mog-black); color: var(--mog-gold); overflow-x: hidden; font-size: 0.95rem; margin: 0; }
        #bg-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -2; filter: grayscale(100%) brightness(12%) contrast(115%); object-fit: cover; pointer-events: none; }
        .crt-overlay { position: fixed; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); z-index: 50; background-size: 100% 2px, 3px 100%; pointer-events: none; opacity: 0.4; }
        .glass-panel { background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(212, 175, 55, 0.15); }
        .btn-uplink { background: var(--mog-gold); color: #000; font-weight: 800; padding: 15px; text-transform: uppercase; cursor: pointer; letter-spacing: 2px; border: none; width: 100%; }
        input, textarea, select { background: rgba(10, 10, 10, 0.9) !important; border: 1px solid rgba(212, 175, 55, 0.1) !important; color: var(--mog-blue) !important; padding: 14px; width: 100%; outline: none; margin-bottom: 10px; }
        #progress-bar { width: 0%; height: 100%; background: var(--mog-gold); box-shadow: 0 0 10px var(--mog-gold); }
        .cat-btn { font-size: 8px; border: 1px solid rgba(0, 212, 255, 0.2); padding: 5px 10px; cursor: pointer; color: var(--mog-blue); text-transform: uppercase; }
        .cat-btn.active { background: var(--mog-blue); color: #000; font-weight: bold; }
        .spotlight-glow { border: 1px solid var(--mog-gold); background: rgba(212, 175, 55, 0.05); animation: pulse-gold 3s infinite; }
        @keyframes pulse-gold { 0%, 100% { box-shadow: 0 0 5px var(--mog-gold); } 50% { box-shadow: 0 0 10px var(--mog-gold); } }
        .scrollbar-hidden::-webkit-scrollbar { width: 4px; }
        .scrollbar-hidden::-webkit-scrollbar-thumb { background: var(--mog-gold); }
    </style>
</head>
<body>
    <video autoplay muted loop playsinline id="bg-video"><source src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/1000211769.mp4" type="video/mp4"></video>
    <div class="crt-overlay"></div>

    <header class="glass-panel p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6 relative z-50">
        <div class="flex items-center gap-6">
            <img src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logo.png" class="h-16 w-16 rounded-full border border-gold">
            <h1 class="text-xl md:text-2xl font-black uppercase tracking-tighter text-gold italic">The Ministry of Groove</h1>
        </div>
        <div class="flex gap-5 items-center">
            <div id="signal-sign" class="text-[9px] font-bold text-gray-500 border border-gray-500 px-3 py-1 cursor-pointer" onclick="OneSignal.showNativePrompt()">SIGNAL OFFLINE</div>
            <a href="mailto:director.mog@gmail.com" class="text-gold text-xl"><i class="fa-solid fa-envelope"></i></a>
            <a href="https://tiktok.com/@ministryofgroove" target="_blank" class="text-gold text-xl"><i class="fa-brands fa-tiktok"></i></a>
            <a href="https://www.facebook.com/share/1D9jcB5998/" target="_blank" class="text-gold text-xl"><i class="fa-brands fa-facebook"></i></a>
            <a href="https://www.instagram.com/ministryofgroove_hq?igsh=Y3Rwc24zcmtsY2xj" target="_blank" class="text-gold text-xl"><i class="fa-brands fa-instagram"></i></a>
            <button id="logout-btn" onclick="logout()" class="hidden text-[9px] border border-red-500 text-red-500 px-2 py-1 uppercase font-bold">Sever Link</button>
        </div>
    </header>

    <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-50">
        
        <section id="auth-panel" class="lg:col-span-4 glass-panel p-6">
            <h2 class="text-xs font-bold uppercase mb-6 border-b border-white/10 pb-2">Identity Hub</h2>
            <div id="auth-form">
                <div class="flex gap-4 mb-6">
                    <button id="tab-login" onclick="toggleAuth('login')" class="text-xs font-black text-white border-b-2 border-gold pb-1">LOGIN</button>
                    <button id="tab-register" onclick="toggleAuth('register')" class="text-xs font-black text-gray-500 pb-1">REGISTER</button>
                </div>
                <input id="email-in" type="email" placeholder="OPERATIVE EMAIL" class="lowercase">
                <input id="password-in" type="password" placeholder="PASSWORD">
                <button onclick="handleAuth()" id="auth-action-btn" class="btn-uplink">Initialize Uplink</button>
            </div>
            <div id="op-profile" class="hidden text-center">
                <div class="flex items-center justify-center gap-2 mb-4">
                    <p id="active-alias" class="text-xl font-black text-white uppercase tracking-widest"></p>
                    <span id="rank-badge" class="text-[9px] px-2 py-1 border border-white/20 uppercase font-black">Recruit</span>
                </div>
                <div id="qrcode" class="bg-white p-2 inline-block mb-4"></div>
                <button onclick="logout()" class="btn-uplink !bg-red-600 !text-white !text-[10px]">SEVER LINK</button>
            </div>
        </section>
        
        <section class="lg:col-span-8 glass-panel p-6">
            <div class="flex justify-between items-center border-b border-white/10 pb-4 mb-4">
                <p class="text-[9px] font-bold text-gold uppercase animate-pulse">‚óè Active Frequency</p>
                <p id="live-time" class="text-[9px] opacity-40"></p>
            </div>
            <div class="text-center py-6">
                <h2 id="live-track" class="text-4xl md:text-6xl font-black italic text-white leading-none">SYNCING...</h2>
                <p id="live-artist" class="text-blue-400 text-sm font-bold tracking-[0.3em] mt-2 uppercase">DIRECTOR OFFLINE</p>
            </div>
            <div id="history-grid" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3 border-t border-white/5 pt-4"></div>
        </section>

        <section class="lg:col-span-12 glass-panel p-6">
            <h2 class="text-xs font-bold uppercase mb-4 text-blue-400 border-b border-white/10 pb-2">Sonic Archive</h2>
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="cat-btn active" onclick="setCategory('ALL', this)">All</button>
                <button class="cat-btn" onclick="setCategory('DEEP', this)">Deep</button>
                <button class="cat-btn" onclick="setCategory('TECH', this)">Tech</button>
                <button class="cat-btn" onclick="setCategory('CHILL', this)">Chill</button>
            </div>
            <input type="text" id="archive-search" placeholder="SEARCH ARCHIVES..." class="text-[10px] mb-4 w-full" oninput="filterArchives()">
            <audio id="player" src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/mandate_mix.mp3" controls class="w-full h-10 mb-4"></audio>
            <div style="height:4px; background:rgba(255,255,255,0.1); margin-top:-10px; margin-bottom:20px;"><div id="progress-bar"></div></div>
            <div id="mix-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[200px] overflow-y-auto pr-2 scrollbar-hidden"></div>
            
            <div id="request-node" class="hidden mt-8 pt-8 border-t border-white/5">
                <input id="track-req-in" type="text" placeholder="REQUEST FREQUENCY..." class="!mb-4">
                <button onclick="submitTrackRequest()" class="bg-blue-600 text-white w-full py-3 text-xs font-black uppercase">Send Request</button>
            </div>
        </section>

        <section class="lg:col-span-6 glass-panel p-6 border-l-4 border-blue-600">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xs font-bold uppercase text-blue-400 border-b border-white/10 pb-1">Active Mission</h2>
                <span id="rsvp-count" class="text-[9px] text-white/40">0 SIGNALED</span>
            </div>
            <h3 id="mission-title" class="text-xl font-black text-white italic">NO ASSIGNED MISSION</h3>
            <button id="rsvp-btn" onclick="submitRSVP()" class="hidden btn-uplink !py-3 !text-[10px] mt-6">Signal Presence</button>
        </section>

        <section class="lg:col-span-6 glass-panel p-6">
            <h2 class="text-xs font-bold uppercase mb-4 text-gold border-b border-white/10 pb-2">Visual Vault</h2>
            <div id="tile-gallery" class="grid grid-cols-3 gap-2 max-h-[200px] overflow-y-auto pr-2 scrollbar-hidden"></div>
        </section>

        <section class="lg:col-span-12 glass-panel p-6">
            <div id="spotlight" class="hidden spotlight-glow p-4 mb-4 rounded flex justify-between items-center">
                <p class="text-xs font-black uppercase text-gold italic">Operative Spotlight: <span id="spotlight-name" class="text-white">...</span></p>
                <p id="spotlight-score" class="text-[10px] text-white/50">0 Mixes</p>
            </div>
            <h2 class="text-xs font-bold uppercase mb-4 text-blue-400 border-b border-white/10 pb-2">Frequency Chat</h2>
            <div id="chat-box" class="h-[240px] overflow-y-auto mb-4 text-sm space-y-2 pr-2 scrollbar-hidden"></div>
            <div id="chat-input-area" class="hidden flex gap-2">
                <input id="chat-in" type="text" placeholder="TRANSMIT MESSAGE..." class="!mb-0" onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="bg-blue-600 px-4 py-2 text-white text-xs font-black">SEND</button>
            </div>
        </section>

        <section id="director-node" class="hidden lg:col-span-12 glass-panel p-8 border-2 border-red-900/40 bg-red-900/5">
            <h3 class="text-red-600 font-black uppercase mb-8 italic tracking-[0.5em] text-center">Directorate Command</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <p class="text-[10px] font-bold text-red-600 mb-4 uppercase">Booth Control</p>
                    <input id="dr-track" placeholder="TRACK NAME">
                    <input id="dr-artist" placeholder="ARTIST NAME">
                    <button onclick="pushTrack()" class="btn-uplink !bg-red-600 !text-white !text-[9px]">Broadcast to Live</button>
                    <div id="dr-request-list" class="mt-4 text-[9px] h-20 overflow-y-auto bg-black/40 p-2"></div>
                </div>
                <div class="md:col-span-2">
                    <p class="text-[10px] font-bold text-red-600 mb-4 uppercase">Intelligence Ledger</p>
                    <textarea id="dr-log" class="h-40 text-[10px]" placeholder="Director's secure logs..."></textarea>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-red-600 mb-4 uppercase">Signal Priority</p>
                    <input id="mission-input" placeholder="SET MISSION">
                    <button onclick="updateMission()" class="btn-uplink !bg-red-600 !text-white !text-[9px]">Push Mission</button>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        const CFG = {
            U: "https://vbkpatwvgvwarybbpiky.supabase.co", 
            K: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZia3BhdHd2Z3Z3YXJpYmJwaWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMjc0MTksImV4cCI6MjA4NjcwMzQxOX0.v3iWw2z9vL-X6pGjY0W_S5m1z0S8uI1L8yN7fL0M_Y8",
            D: "director.mog@gmail.com"
        };
        const db = window.supabase.createClient(CFG.U, CFG.K);
        let authMode = 'login'; let vaultData = []; let currentCat = 'ALL'; let opRank = 'Recruit';

        // THE SECURE HANDSHAKE ENGINE
        async function handleAuth() {
            const e = document.getElementById('email-in').value.trim();
            const p = document.getElementById('password-in').value;
            if (authMode === 'register') {
                const { error } = await db.auth.signUp({ email: e, password: p });
                if (error) alert(error.message); else alert("Check email to confirm recruitment.");
            } else {
                const { error } = await db.auth.signInWithPassword({ email: e, password: p });
                if (error) alert(error.message);
            }
        }

        // PERSISTENCE LISTENER (THE FIX)
        db.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                if (session) mountSession(session.user);
            } else if (event === 'SIGNED_OUT') {
                location.reload();
            }
        });

        async function mountSession(u) {
            document.getElementById('auth-form').classList.add('hidden');
            document.getElementById('op-profile').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');
            document.getElementById('request-node').classList.remove('hidden');
            document.getElementById('active-alias').innerText = u.email.split('@')[0].toUpperCase();
            
            if (u.email === CFG.D) {
                document.getElementById('director-node').classList.remove('hidden');
                document.getElementById('dr-log').value = localStorage.getItem('mog_dr_log') || '';
                document.getElementById('dr-log').oninput = (e) => localStorage.setItem('mog_dr_log', e.target.value);
            }
            new QRCode(document.getElementById("qrcode"), { text: u.id, width: 140, height: 140 });
            loadRSVPs();
        }

        async function logout() { await db.auth.signOut(); }

        window.onload = () => {
            loadVault(); loadChat(); loadMissions(); loadHistory();
            setInterval(() => { document.getElementById('live-time').innerText = new Date().toLocaleTimeString(); }, 1000);
            const p = document.getElementById('player');
            p.ontimeupdate = () => document.getElementById('progress-bar').style.width = (p.currentTime/p.duration)*100 + "%";
            
            db.channel('live').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'live_setlist' }, payload => {
                document.getElementById('live-track').innerText = payload.new.track_name;
                document.getElementById('live-artist').innerText = payload.new.artist_name;
                loadHistory();
            }).subscribe();
        };

        // RESTORED: VAULT, CHAT, MISSIONS, HISTORY
        async function loadVault() {
            const { data: files } = await db.storage.from('intel-vault').list('', { sortBy: { column: 'created_at', order: 'desc' } });
            vaultData = files || []; renderVault(vaultData);
        }

        function renderVault(files) {
            const list = document.getElementById('mix-list'); const tiles = document.getElementById('tile-gallery');
            list.innerHTML = ""; tiles.innerHTML = "";
            files.forEach(f => {
                const url = `${CFG.U}/storage/v1/object/public/intel-vault/${f.name}`;
                if (f.name.match(/\.(mp3|wav)$/)) {
                    list.innerHTML += `<div class="p-3 border border-white/5 bg-white/5 flex justify-between items-center"><span class="text-[10px] truncate cursor-pointer" onclick="document.getElementById('player').src='${url}';document.getElementById('player').play()">${f.name}</span><a href="${url}" download class="text-[8px] border border-gold px-2 py-1">Secure</a></div>`;
                } else if (f.name.match(/\.(jpg|png|webp)$/)) {
                    tiles.innerHTML += `<div class="aspect-square bg-black/40 border border-white/5 overflow-hidden"><img src="${url}" class="w-full h-full object-cover grayscale hover:grayscale-0 transition duration-1000"></div>`;
                }
            });
        }

        async function loadHistory() {
            const { data } = await db.from('live_setlist').select('*').order('created_at', { ascending: false }).limit(4);
            const grid = document.getElementById('history-grid');
            if(data) grid.innerHTML = data.map(t => `<div class="text-[8px] border-l border-gold/20 pl-2"><p class="text-white uppercase truncate">${t.track_name}</p><p class="text-blue-400 opacity-50">${t.artist_name}</p></div>`).join('');
        }

        async function sendChat() {
            const i = document.getElementById('chat-in');
            const { data: { user } } = await db.auth.getUser();
            if(!i.value || !user) return;
            await db.from('chat').insert([{ alias: user.email.split('@')[0], message: i.value, rank: opRank }]);
            i.value = '';
        }

        async function loadChat() {
            const { data } = await db.from('chat').select('*').order('created_at', { ascending: true }).limit(50);
            if(data) data.forEach(m => {
                document.getElementById('chat-box').innerHTML += `<div><span class="text-blue-400 font-bold">${m.alias}:</span> ${m.message}</div>`;
            });
        }
        
        function toggleAuth(m) {
            authMode = m;
            document.getElementById('tab-login').className = m === 'login' ? "text-xs font-black text-white border-b-2 border-gold pb-1" : "text-xs font-black text-gray-500 pb-1";
            document.getElementById('tab-register').className = m === 'register' ? "text-xs font-black text-white border-b-2 border-gold pb-1" : "text-xs font-black text-gray-500 pb-1";
        }

        async function pushTrack() {
            const t = document.getElementById('dr-track').value;
            const a = document.getElementById('dr-artist').value;
            await db.from('live_setlist').insert([{ track_name: t, artist_name: a }]);
        }
    </script>
</body>
</html>
