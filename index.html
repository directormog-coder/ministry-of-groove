<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">

    <title>M.O.G. | SOVEREIGN GRID</title>
    <meta name="description" content="Sovereign sound transmission from eMalahleni Sector.">
    <meta property="og:title" content="Ministry of Groove | Official Grid">
    <meta property="og:image" content="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.4.13/dist/easy.qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Big+Shoulders+Display:wght@900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --mog-gold: #D4AF37; --mog-blue: #00d4ff; --mog-black: #050505; 
            --mog-glass: rgba(5, 12, 20, 0.98); --mog-border: rgba(0, 212, 255, 0.15);
        }

        /* GLITCH FIX: LOCK OVERSCROLL AND GPU ACCELERATE */
        html, body { 
            min-height: 100vh; width: 100vw; margin: 0; padding: 0; 
            overflow-x: hidden; background-color: var(--mog-black); color: #fff; 
            font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        #bg-canvas { 
            position: fixed; inset: 0; z-index: -1; 
            background: radial-gradient(circle at 50% 50%, rgba(0, 212, 255, 0.06) 0%, transparent 70%); 
            transform: translateZ(0); pointer-events: none;
        }

        /* REFINED GRID SYSTEM */
        .mainframe-wrapper { 
            display: grid; padding: 20px; gap: 20px; 
            grid-template-columns: 1.2fr 1.6fr 1fr; 
            grid-template-areas: "gateway messenger chart" "location messenger vault" "history messenger requests" "director director director"; 
            max-width: 1800px; margin: 0 auto; 
        }
        @media (max-width: 1150px) { 
            .mainframe-wrapper { 
                grid-template-columns: 1fr; 
                grid-template-areas: "gateway" "messenger" "chart" "location" "vault" "history" "requests" "director"; 
                padding: 12px; 
            } 
        }

        .command-tile { 
            background: var(--mog-glass); border: 1px solid var(--mog-border); 
            border-radius: 35px; backdrop-filter: blur(30px); 
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* OVERLAY SYSTEM */
        #live-siren, #share-overlay { 
            position: fixed; inset: 0; z-index: 10005; 
            background: rgba(0,0,0,0.96); display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(60px); 
        }

        .master-btn { 
            background: var(--mog-gold); color: #000; font-weight: 900; 
            border-radius: 14px; padding: 16px; width: 100%; 
            text-transform: uppercase; cursor: pointer; font-size: 11px; border: none;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
        }
        
        .mog-input { 
            background: rgba(255,255,255,0.03); border: none; 
            border-bottom: 2px solid var(--mog-border); padding: 12px; 
            color: #fff; width: 100%; text-align: center; 
            font-family: 'JetBrains Mono'; font-size: 12px; outline: none;
        }

        #director-tile { grid-area: director; display: none; border: 1px solid #ef4444; margin-top: 15px; }
        .director-active #director-tile { display: block; }
        
        /* SMOOTH SCROLLING FOR CHAT */
        #chat-stream { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        
        .logo-glow { animation: pulse-glow 4s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 2px var(--mog-blue)); } 50% { filter: drop-shadow(0 0 12px var(--mog-gold)); } }
    </style>
</head>
<body class="pb-28">
    <div id="bg-canvas"></div>

    <div id="live-siren">
        <div class="text-center p-6">
            <h1 class="text-blue-400 font-black italic text-5xl mb-6 uppercase tracking-tighter">Live Feed</h1>
            <button onclick="document.getElementById('live-siren').style.display='none'" class="master-btn max-w-xs">Acknowledge Sync</button>
        </div>
    </div>
    
    <div id="share-overlay">
        <div class="command-tile p-10 text-center max-w-sm w-full mx-4">
            <span class="text-gold font-black uppercase text-[10px] mb-8 block tracking-widest">Viral Frequency</span>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="viralTransmit('whatsapp')" class="p-4 bg-white/5 rounded-2xl hover:bg-gold hover:text-black"><i class="fa-brands fa-whatsapp text-2xl"></i></button>
                <button onclick="viralTransmit('twitter')" class="p-4 bg-white/5 rounded-2xl hover:bg-gold hover:text-black"><i class="fa-brands fa-x-twitter text-2xl"></i></button>
                <button onclick="viralTransmit('fb-msg')" class="p-4 bg-white/5 rounded-2xl hover:bg-gold hover:text-black"><i class="fa-brands fa-facebook-messenger text-2xl"></i></button>
            </div>
            <button onclick="document.getElementById('share-overlay').style.display='none'" class="mt-8 text-[10px] uppercase text-zinc-500 underline">Close Grid</button>
        </div>
    </div>

    <header class="px-6 py-5 border-b border-white/5 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-xl z-[1000]">
        <div class="flex items-center gap-4" onclick="handleDirectorSequence()">
            <img src="logo.png" class="h-10 w-10 md:h-12 md:w-12 rounded-full cursor-pointer logo-glow" onerror="this.src='https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logo.png'">
            <h1 class="text-xl md:text-2xl font-black italic uppercase tracking-tight" style="font-family: 'Big Shoulders Display';">M.O.G.</h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="document.getElementById('share-overlay').style.display='flex'" class="text-gold p-2"><i class="fa-solid fa-share-nodes"></i></button>
            <div class="bg-white/5 px-4 py-2 rounded-full border border-white/10 flex items-center gap-3">
                <span id="op-counter" class="text-gold font-black text-lg">0</span>
                <button onclick="initiateLogout()" class="text-red-500 text-xs"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </div>
    </header>

    <main class="mainframe-wrapper">
        <section class="command-tile p-8 flex flex-col items-center justify-center" style="grid-area: gateway;">
            <div id="qrcode" class="bg-white p-2 rounded-2xl border-4 border-white shadow-xl"></div>
            <h2 id="op-display-id" class="text-md font-black italic mt-5 text-gold uppercase tracking-widest">SECURE LINK</h2>
        </section>

        <section class="command-tile min-h-[500px] flex flex-col" style="grid-area: messenger;">
            <div id="chat-stream" class="flex-grow p-5 overflow-y-auto space-y-4"></div>
            <div class="p-4 bg-black/40 flex gap-3 border-t border-white/5">
                <input type="text" id="chat-input" class="flex-grow bg-white/5 rounded-full px-5 py-3 outline-none text-xs" placeholder="Transmit packet...">
                <button onclick="sendPacket()" class="bg-blue-600 w-11 h-11 rounded-full flex items-center justify-center shadow-lg active:scale-90"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </section>

        <section class="command-tile p-6" style="grid-area: chart;"><span class="text-[9px] font-black text-gold uppercase underline tracking-wider">Top 10 Index</span><div id="chart-list" class="mt-4 space-y-2"></div></section>
        <section class="command-tile p-6 h-44" style="grid-area: location;"><span class="text-[9px] font-black text-blue-400 uppercase underline tracking-wider">Sector Coords</span><div id="loc-node" class="mt-3 text-[10px] text-center uppercase font-bold text-zinc-400"></div></section>
        <section class="command-tile p-6 h-72 overflow-y-auto" style="grid-area: vault;"><span class="text-[9px] font-black text-blue-400 uppercase underline tracking-wider">Intel Vault</span><div id="vault-list" class="mt-4 space-y-3"></div></section>
        <section class="command-tile p-6 h-72 overflow-y-auto" style="grid-area: history;"><span class="text-[9px] font-black text-gold uppercase underline tracking-wider">Set Archive</span><div id="set-list" class="mt-4 space-y-2"></div></section>
        <section class="command-tile p-6" style="grid-area: requests;"><span class="text-[9px] font-black text-blue-400 uppercase underline tracking-wider">Booth Request</span><input id="req-in" class="mog-input mt-3 mb-3" placeholder="Artist - Track"><button onclick="sendReq()" class="master-btn">Send Frequency</button></section>

        <section id="director-tile" class="command-tile p-8 col-span-full border-red-500/40">
            <h2 class="text-red-500 font-black text-md uppercase mb-6 tracking-widest">Directorate Console</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="triggerSiren()" class="bg-blue-600 py-3 rounded-xl font-black text-[10px] uppercase">Fire Siren</button>
                <button onclick="initiateLogout()" class="bg-zinc-800 py-3 rounded-xl font-black text-[10px] uppercase">Kill Grid Access</button>
            </div>
        </section>
    </main>

    <footer class="text-center py-10 opacity-20 text-[8px] uppercase font-black tracking-[0.4em]">M.O.G. Totality // V100.2.88</footer>

    <script>
        const CFG = { U: "https://hzelmkthdqtbcxffsstl.supabase.co", K: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6ZWxta3RoZHF0YmN4ZmZzc3RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDExOTksImV4cCI6MjA4NzM3NzE5OX0.Hx-dlAnPYqn-1GAmkS0ZNJIuvhutYdJ2_fLxAn3MTfY" };
        const db = window.supabase.createClient(CFG.U, CFG.K);
        let clicks = 0;

        window.onload = async () => {
            const { data: { user } } = await db.auth.getUser();
            if (user && sessionStorage.getItem('mog_handshake_verified') === 'true') {
                document.getElementById('op-display-id').innerText = user.email.split('@')[0].toUpperCase();
                if(user.email === 'director.mog@gmail.com') document.documentElement.classList.add('director-active');
                
                // GLITCH FIX: Ensure QR renders after DOM is stable
                setTimeout(() => {
                    new QRCode(document.getElementById("qrcode"), { text: user.id, width: 130, height: 130, colorDark: "#D4AF37", quietZone: 10 });
                }, 300);
                
                initGrid();
            } else { location.reload(); }
        };

        async function initGrid() {
            // LOAD TILES (Aliased)
            const { data: v } = await db.from('messages').select('*').eq('alias', 'VAULT_ITEM').order('created_at', { ascending: false });
            if(v) v.forEach(i => document.getElementById('vault-list').innerHTML += `<div class="bg-white/5 p-3 rounded-xl border border-white/5 text-[9px] uppercase font-bold">${i.content.split('|')[1] || 'New Intel'}</div>`);

            const { data: m } = await db.from('messages').select('*').order('created_at', { ascending: false }).limit(25);
            if(m) m.reverse().forEach(appendMsg);

            // REALTIME CHANNELS
            db.channel('totality').on('broadcast', { event: 'live' }, () => document.getElementById('live-siren').style.display = 'flex').subscribe();
            db.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => appendMsg(p.new)).subscribe();
        }

        function appendMsg(m) {
            if(['VAULT','YT','SET','SECTOR','REQ'].some(k => m.alias.includes(k))) return;
            const s = document.getElementById('chat-stream');
            const d = document.createElement('div');
            d.className = "bg-white/5 p-3 rounded-2xl border border-white/5 mb-2";
            d.innerHTML = `<span class="text-blue-400 block font-black text-[8px] uppercase mb-1">${m.alias}</span>${m.content}`;
            s.appendChild(d);
            // GLITCH FIX: Auto-scroll only if user is near bottom
            s.scrollTop = s.scrollHeight;
        }

        async function sendPacket() {
            const i = document.getElementById('chat-input');
            const { data: { user } } = await db.auth.getUser();
            if(i.value.trim() && user) {
                await db.from('messages').insert([{ content: i.value, alias: user.email.split('@')[0], user_id: user.id }]);
                i.value = "";
            }
        }

        function viralTransmit(p) {
            const u = encodeURIComponent(window.location.href);
            window.open(`https://api.whatsapp.com/send?text=Join the Ministry Grid: ${u}`, '_blank');
        }

        function handleDirectorSequence() { clicks++; if(clicks === 5) document.documentElement.classList.add('director-active'); }
        async function initiateLogout() { await db.auth.signOut(); sessionStorage.clear(); location.reload(); }
        async function triggerSiren() { db.channel('totality').send({ type: 'broadcast', event: 'live' }); }
        async function sendReq() {
            const t = document.getElementById('req-in').value;
            const { data: { user } } = await db.auth.getUser();
            if(t.trim() && user) {
                await db.from('messages').insert([{ content: t, alias: `REQ_${user.email.split('@')[0]}`, user_id: user.id }]);
                document.getElementById('req-in').value = "";
                alert("Frequency Transmitted.");
            }
        }
    </script>
</body>
</html>
