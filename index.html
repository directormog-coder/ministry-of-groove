<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>M.O.G. | NATIONAL GRID MASTER V218.00</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://api.fontshare.com/v2/css?f[]=clash-display@700&f[]=satoshi@400,900&display=swap');
        :root { --mog-gold: #D4AF37; --mog-blue: #00d4ff; --mog-bg: #030508; --mog-panel: rgba(13, 20, 28, 0.95); --chat-sent: #005c4b; --chat-received: #202c33; }
        * { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); font-family: 'Satoshi', sans-serif; box-sizing: border-box; }
        body { background-color: var(--mog-bg); background-image: radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.02) 1px, transparent 0); background-size: 40px 40px; color: var(--mog-gold); min-height: 100vh; overflow-x: hidden; }
        .mainframe-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr)); gap: 1.5rem; padding: 1.5rem; max-width: 1800px; margin: 0 auto; }
        .command-tile { background: var(--mog-panel); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px); border-radius: 30px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.8); }
        @media (min-width: 1024px) { .lg-span-2 { grid-column: span 2; } .full-width { grid-column: 1 / -1; } }
        .messenger-view { height: clamp(500px, 75vh, 850px); display: flex; flex-direction: column; background: #0b1014; }
        .msg-stream { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.9rem; }
        .sent { align-self: flex-end; background: var(--chat-sent); color: #e9edef; border-top-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--chat-received); color: #e9edef; border-top-left-radius: 4px; }
        .modal-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.98); backdrop-filter: blur(30px); display: none; align-items: center; justify-content: center; padding: 1rem; }
        .active-modal { display: flex !important; }
        #mog-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: var(--mog-blue); color: #000; padding: 12px 24px; border-radius: 50px; font-weight: 900; z-index: 10001; }
        .toast-active { bottom: 2rem !important; }
        .rank-legend { color: #ef4444; font-weight: 900; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .glow-gold { text-shadow: 0 0 10px #D4AF37; color: #fff !important; }
        .medal { font-size: 8px; padding: 1px 4px; border-radius: 3px; border: 1px solid currentColor; margin-left: 2px; background: rgba(0,0,0,0.4); }
    </style>
</head>
<body id="mog-mainframe">
    <div id="mog-toast">GRID OMNI-REMASTERED</div>
    <audio id="log-drum" src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logdrum.mp3"></audio>

    <div id="grid-store" class="modal-overlay">
        <div class="command-tile p-8 max-w-4xl w-full border-blue-500/20 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl text-white font-black uppercase italic">Grid Store</h2>
                <div class="text-blue-400 font-black">BALANCE: <span id="store-balance">0</span> PKTS</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/5 p-6 rounded-3xl text-center border border-white/10">
                    <p class="text-white font-black mb-2">GOLDEN DNA GLOW</p>
                    <button onclick="buyItem('GLOW_GOLD', 50)" class="bg-blue-500 text-black px-6 py-2 rounded-full font-black text-[10px] uppercase">50 PKTS</button>
                </div>
            </div>
            <button onclick="toggleUI('grid-store')" class="mt-8 text-zinc-500 uppercase font-black text-[10px]">Close</button>
        </div>
    </div>

    <div class="w-full mt-24">
        <header class="text-center px-4 mb-16">
            <img src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logo.png" id="mog-logo-trigger" class="h-32 md:h-44 mx-auto cursor-pointer">
            <h1 class="text-5xl md:text-8xl text-gold font-black uppercase italic mt-8 leading-none">Ministry of Groove</h1>
            <button onclick="toggleUI('grid-store')" class="mt-6 inline-block border border-blue-400 px-8 py-2 rounded-full text-blue-400 font-black text-[10px] uppercase hover:bg-blue-400 hover:text-black">Enter Economy</button>
        </header>
        
        <div class="mainframe-grid">
            <section class="command-tile p-10">
                <h3 class="text-white font-black uppercase text-xs mb-8 italic border-l-4 border-gold pl-4">DNA Matrix</h3>
                <div id="auth-container" class="space-y-4">
                    <input id="auth-user" type="text" class="w-full bg-white/5 p-4 rounded-xl text-white outline-none border border-white/10" placeholder="GRID EMAIL">
                    <input id="auth-pass" type="password" class="w-full bg-white/5 p-4 rounded-xl text-white outline-none border border-white/10" placeholder="DNA PASSCODE">
                    <button onclick="executeAuth()" class="w-full bg-blue-500 text-black font-black py-5 rounded-2xl uppercase text-xs">Authorize</button>
                </div>
                <div id="active-op-badge" class="hidden text-center py-4">
                    <img id="display-avatar" class="w-32 h-32 rounded-[2rem] mx-auto mb-4 border-2 border-gold object-cover" src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logo.png">
                    <h2 id="display-op-id" class="text-2xl text-white font-black uppercase italic">OPERATIVE</h2>
                    <div id="display-rank" class="text-[10px] font-black uppercase tracking-widest mb-2">Initiate</div>
                    <div id="display-medals" class="flex flex-wrap justify-center gap-1"></div>
                </div>
            </section>

            <section class="command-tile p-10 lg-span-2">
                <h3 class="text-white font-black uppercase text-xs mb-8 italic border-l-4 border-blue-500 pl-4">Amapiano Top 10 Hitlist</h3>
                <div id="hitlist-container" class="flex overflow-x-auto gap-4 pb-4"></div>
            </section>

            <section class="command-tile p-3 aspect-video lg-span-2">
                <div id="yt-broadcast" class="w-full h-full bg-black rounded-[35px] overflow-hidden"></div>
            </section>

            <section class="command-tile p-1 full-width">
                <div class="messenger-view rounded-[39px]">
                    <div id="chat-stream" class="msg-stream"></div>
                    <div class="bg-[#202c33] p-6 flex gap-4">
                        <input id="chat-msg" type="text" class="flex-grow bg-[#2a3942] rounded-2xl px-8 py-5 text-white outline-none" placeholder="Transmit packet...">
                        <button onclick="sendMessage()" class="w-16 h-16 bg-blue-600 text-black rounded-full flex items-center justify-center transform active:scale-90"><i class="fa-solid fa-paper-plane text-xl"></i></button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const MOG_CFG = { U: "https://hzelmkthdqtbxcffsstl.supabase.co", K: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6ZWxta3RoZHF0YmN4ZmZzc3RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDExOTksImV4cCI6MjA4NzM3NzE5OX0.Hx-dlAnPYqn-1GAmkS0ZNJIuvhutYdJ2_fLxAn3MTfY" };
        const db = window.supabase.createClient(MOG_CFG.U, MOG_CFG.K);
        let currentOp = null, opStyle = 'none', opRanks = {}, opMedals = {}, blacklist = [];

        function showToast(msg) { const t = document.getElementById('mog-toast'); t.innerText = msg; t.classList.add('toast-active'); setTimeout(() => t.classList.remove('toast-active'), 4000); document.getElementById('log-drum').play(); }
        
        async function executeAuth() {
            const email = document.getElementById('auth-user').value.trim(), password = document.getElementById('auth-pass').value;
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) { 
                const { error: regErr } = await db.auth.signUp({ email, password, options: { data: { full_name: 'OPERATIVE' } } });
                if (regErr) showToast(regErr.message); else showToast("DNA REGISTERED. VERIFY EMAIL.");
            } else setupSession(data.user);
        }

        async function setupSession(u) {
            currentOp = u; document.getElementById('auth-container').classList.add('hidden'); document.getElementById('active-op-badge').classList.remove('hidden');
            document.getElementById('display-op-id').innerText = u.user_metadata.full_name;
            await syncGridData(); refreshChat(); syncGrid(); loadHitlist();
        }

        async function syncGridData() {
            const { data: ranks } = await db.from('operative_ranks').select('*');
            ranks?.forEach(r => opRanks[r.alias] = r);
            const { data: ach } = await db.from('achievements').select('*');
            opMedals = {}; ach?.forEach(a => { if(!opMedals[a.operative_alias]) opMedals[a.operative_alias] = []; opMedals[a.operative_alias].push(a.medal_type); });
            const { data: bl } = await db.from('blacklist').select('operative_alias');
            blacklist = bl?.map(b => b.operative_alias) || [];
            
            if (currentOp) {
                const alias = currentOp.user_metadata.full_name;
                const r = opRanks[alias] || { rank_title: 'Initiate', packet_count: 0 };
                document.getElementById('display-rank').innerText = r.rank_title;
                document.getElementById('store-balance').innerText = r.packet_count;
                document.getElementById('display-medals').innerHTML = (opMedals[alias] || []).map(m => `<span class="medal">${m}</span>`).join('');
            }
        }

        async function sendMessage() {
            const i = document.getElementById('chat-msg'); if(!i.value || !currentOp || blacklist.includes(currentOp.user_metadata.full_name)) return;
            await db.from('messages').insert([{ content: i.value, user_id: currentOp.id, alias: currentOp.user_metadata.full_name, profile_style: opStyle }]);
            i.value = '';
        }

        async function refreshChat() {
            const { data } = await db.from('messages').select('*').order('created_at', { ascending: true }).limit(50);
            document.getElementById('chat-stream').innerHTML = data?.map(m => {
                const r = opRanks[m.alias] || { rank_title: 'Initiate' };
                return `<div class="bubble ${m.user_id === currentOp?.id ? 'sent' : 'received'}"><span class="text-[8px] font-black uppercase block mb-1 ${m.profile_style}">${m.alias} [${r.rank_title}]</span>${blacklist.includes(m.alias) ? '--- BLOCKED ---' : m.content}</div>`;
            }).join('');
            document.getElementById('chat-stream').scrollTop = document.getElementById('chat-stream').scrollHeight;
        }

        async function syncGrid() { const { data } = await db.from('broadcast').select('*').eq('id', 1).single(); if (data) document.getElementById('yt-broadcast').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${data.youtube_id}?autoplay=1&mute=1" frameborder="0" allowfullscreen></iframe>`; }
        async function loadHitlist() { 
            const { data } = await db.from('tracks').select('*').order('votes', { ascending: false }).limit(10); 
            document.getElementById('hitlist-container').innerHTML = data?.map((tk, idx) => `<div class="hit-item p-4"><div class="aspect-video w-full mb-4"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/${tk.youtube_id}" frameborder="0"></iframe></div><p class="text-[8px] text-blue-400 font-black">#0${idx+1}</p><p class="text-xs text-white truncate font-black">${tk.name}</p></div>`).join(''); 
        }

        function toggleUI(id) { document.getElementById(id).classList.toggle('active-modal'); }
        db.channel('master').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => { refreshChat(); syncGridData(); }).subscribe();
        window.onload = () => { syncGrid(); loadHitlist(); };
    </script>
</body>
</html>
