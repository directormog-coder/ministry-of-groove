<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>M.O.G. | NATIONAL AMAPIANO GRID V71.3.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <style>
        @import url('https://api.fontshare.com/v2/css?f[]=clash-display@700&f[]=satoshi@400,900&display=swap');
        :root { --mog-gold: #D4AF37; --mog-blue: #00d4ff; --mog-bg: #060a0f; --mog-panel: rgba(10, 20, 30, 0.95); }
        * { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); font-family: 'Satoshi', sans-serif; box-sizing: border-box; }
        h1 { font-family: 'Clash Display', sans-serif; }
        body { background-color: var(--mog-bg); color: var(--mog-gold); min-height: 100vh; overflow-x: hidden; }
        .command-tile { background: var(--mog-panel); border: 1px solid rgba(0, 212, 255, 0.2); backdrop-filter: blur(30px); border-radius: 28px; overflow: hidden; }
        .auth-input { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; width: 100%; color: white; margin-bottom: 10px; outline: none; }
        .auth-btn { background: white; color: black; font-weight: 900; border-radius: 30px; padding: 14px; width: 100%; text-transform: uppercase; cursor: pointer; }
        #side-menu { position: fixed; top: 0; right: -320px; width: 320px; height: 100%; background: #080c10; z-index: 3000; padding: 2.5rem; transition: 0.6s; }
        #side-menu.active { right: 0; }
        .qr-wrapper { position: relative; display: inline-block; background: white; padding: 15px; border-radius: 15px; }
        .qr-logo-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 35px; height: 35px; border-radius: 50%; }
        .mog-bubble { padding: 10px 15px; border-radius: 18px; font-size: 13px; color: #fff; background: rgba(0, 212, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.15); margin-bottom: 10px; }
    </style>
</head>
<body class="scrollbar-hide">

    <div id="ticker-wrap" class="fixed top-0 w-full bg-black z-[1000] h-[35px] border-b border-blue-400/30 flex items-center overflow-hidden">
        <div class="ticker-move text-[9px] font-black uppercase text-blue-400 whitespace-nowrap animate-marquee">
            MASTER_V71.3.0 // DIAGNOSTIC_HIDDEN // DIRECTOR_TOTALITY_ACTIVE // UNIVERSAL_LOGIN_MAPPING // SQL_V3_SYNCED...
        </div>
    </div>

    <button onclick="toggleMenu()" class="fixed top-12 right-5 z-[2500] text-blue-400 text-2xl p-2 bg-black/40 rounded-full border border-white/5 backdrop-blur-md"><i class="fa-solid fa-bars-staggered"></i></button>
    
    <nav id="side-menu">
        <div class="flex justify-between items-center mb-6"><span class="text-gold font-black uppercase text-xs italic">Sovereign Folders</span><button onclick="toggleMenu()"><i class="fa-solid fa-xmark text-xl text-zinc-500"></i></button></div>
        <button onclick="viewSession('001')" class="w-full text-left p-3 text-[10px] text-white bg-white/5 rounded-lg border border-white/10 mb-2">SESSION 001</button>
        <button onclick="generateEntryTicket()" id="ticket-btn" class="hidden w-full bg-emerald-600 text-white text-[9px] font-black py-4 rounded-full uppercase mt-8">Download Entry Pass</button>
        <button onclick="logoutOperative()" id="logout-btn" class="hidden w-full bg-red-900/20 border border-red-500/50 text-red-500 text-[9px] font-black py-4 rounded-full uppercase mt-4">Terminate Session</button>
    </nav>

    <div id="app-content" class="container mx-auto px-4 mt-20">
        <header class="flex items-center gap-6 mb-12">
            <img src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logo.png" onclick="handleLogoSequence()" class="h-20 w-20 cursor-pointer">
            <div>
                <h1 class="text-3xl md:text-5xl text-gold font-black uppercase italic">Ministry of Groove</h1>
                <p class="text-[10px] text-blue-400 font-black tracking-widest uppercase italic">Decrypting the Culture. Synchronizing the Grid.</p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8 pb-12">
            <div class="lg:col-span-4 space-y-8">
                <section class="command-tile p-8 bg-black/60 shadow-2xl">
                    <div id="auth-ui" class="space-y-4">
                        <div id="auth-header" class="text-center mb-4"><span class="text-white font-black uppercase tracking-[.4em] text-[10px]">Neural Handshake</span></div>
                        <div id="auth-fields">
                            <input id="login-user" type="text" placeholder="PHONE / GMAIL / USERNAME" class="auth-input">
                            <input id="login-pass" type="password" placeholder="PASSCODE" class="auth-input">
                            <button id="main-auth-btn" onclick="handleMainAuth()" class="auth-btn">Authorize</button>
                            <button id="toggle-auth-btn" onclick="toggleAuthMode()" class="w-full mt-4 text-[9px] text-blue-400 font-black uppercase">Create Profile</button>
                        </div>
                        <div id="active-op-badge" class="hidden p-4 border border-emerald-500/30 bg-emerald-500/5 rounded-xl text-center">
                            <span class="text-[10px] text-emerald-500 font-black uppercase tracking-widest">Operative Online</span>
                            <p id="display-op-id" class="text-[12px] text-white font-black mt-1 uppercase"></p>
                        </div>
                    </div>
                </section>
                <section id="registration-tile" class="command-tile p-8 border-gold/30 opacity-40 pointer-events-none">
                    <span class="text-[10px] text-gold font-black uppercase block mb-4">Registry</span>
                    <input type="text" id="delegate-alias" placeholder="ALIAS" class="auth-input">
                    <button onclick="submitDelegate()" class="auth-btn" style="background:var(--mog-gold)">Finalize</button>
                </section>
            </div>
            <div class="lg:col-span-8">
                <section class="command-tile h-[500px] flex flex-col">
                    <div id="chat-stream" class="flex-grow p-6 scroller-v overflow-y-auto"></div>
                    <div class="p-4 bg-black/80 flex gap-2">
                        <input type="text" id="chat-msg-in" placeholder="..." class="flex-grow bg-[#111] border border-white/10 rounded-full px-4 text-xs text-white outline-none">
                        <button onclick="sendPacket()" class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <div id="director-totality" class="hidden fixed inset-0 z-[5000] bg-black/98 p-8 overflow-y-auto backdrop-blur-3xl">
        <div class="flex justify-between items-center mb-12 border-b border-gold/30 pb-4">
            <h2 class="text-3xl text-white font-black uppercase italic">Master Console</h2>
            <button onclick="closeDirector()" class="text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div class="command-tile p-8 border-blue-400/40 text-center">
                <button onclick="runGridDiagnostic()" class="w-full bg-red-600 text-white p-3 rounded-full shadow-lg text-[10px] font-black uppercase mb-4">Run Grid Diagnostic</button>
                <button onclick="exportAttendeeList()" class="w-full bg-emerald-600/20 border border-emerald-500 text-emerald-500 text-[9px] font-black py-3 rounded-full uppercase">Export S001 List</button>
            </div>
            <div class="command-tile p-8 border-gold/40 text-center">
                <div class="flex justify-between text-xs"><span>Gross Revenue:</span><input type="number" id="tax-gross" oninput="calcTax()" class="bg-transparent text-right w-24 border-b border-white/10" value="0"></div>
                <div class="flex justify-between text-xs text-emerald-500 font-black mt-2"><span>Net Profit:</span><span id="tax-net">R0.00</span></div>
            </div>
        </div>
    </div>

    <div id="ticket-portal" class="hidden fixed inset-0 z-[4000] bg-black/95 flex items-center justify-center p-4">
        <div class="secure-ticket">
            <div class="qr-wrapper my-4"><div id="ticket-qrcode"></div><img src="https://raw.githubusercontent.com/directormog-coder/Ministry-of-Groove/main/logo.png" class="qr-logo-overlay"></div>
            <p id="ticket-alias" class="text-blue-400 text-[10px] font-black uppercase"></p>
        </div>
    </div>

    <script>
        const CFG = { U: "https://vbkpatwvgvwarybbpiky.supabase.co", K: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZia3BhdHd2Z3Z3YXJpYmJwaWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMjc0MTksImV4cCI6MjA4NjcwMzQxOX0.v3iWw2z9vL-X6pGjY0W_S5m1z0S8uI1L8yN7fL0M_Y8" };
        const db = window.supabase.createClient(CFG.U, CFG.K);
        let currentOp = null, isSignup = false, idleTimer, logoClicks = 0;

        function toggleMenu() { document.getElementById('side-menu').classList.toggle('active'); }
        function closeDirector() { document.getElementById('director-totality').classList.add('hidden'); }
        function handleLogoSequence() { logoClicks++; if (logoClicks === 5) { document.getElementById('director-totality').classList.remove('hidden'); logoClicks = 0; } setTimeout(() => logoClicks = 0, 5000); }

        async function runGridDiagnostic() {
            try {
                const { error: mErr } = await db.from('messages').select('count');
                const { error: rErr } = await db.from('registrations').select('count');
                if (mErr || rErr) throw new Error("Tables Missing");
                alert("✅ GRID ONLINE: All master tables verified.");
            } catch (e) { alert("❌ SYSTEM OFFLINE: Tables not found. Run the latest SQL script."); }
        }

        function toggleAuthMode() {
            isSignup = !isSignup;
            document.getElementById('auth-header').innerText = isSignup ? "Operative Registry" : "Neural Handshake";
            document.getElementById('main-auth-btn').innerText = isSignup ? "Register Profile" : "Authorize";
        }

        async function handleMainAuth() {
            const u = document.getElementById('login-user').value.trim(), p = document.getElementById('login-pass').value;
            if (u === 'director.mog@gmail.com' && p === '@MOGProtocol2026') { currentOp = { email: u, id: 'MASTER' }; syncClearance(true); return; }
            let email = u.includes('@') ? u : (/^\d+$/.test(u) ? `${u}@phone.mog.internal` : `${u}@user.mog.internal`);
            try {
                const { data, error } = isSignup ? await db.auth.signUp({ email, password: p }) : await db.auth.signInWithPassword({ email, password: p });
                if(!error) { currentOp = data.user; syncClearance(false); }
                else alert("Handshake Denied: " + error.message);
            } catch (e) { alert("Network Error. Ensure SQL script was run."); }
        }

        function syncClearance(isDirector) {
            document.getElementById('auth-fields').classList.add('hidden');
            document.getElementById('active-op-badge').classList.remove('hidden');
            document.getElementById('display-op-id').innerText = currentOp.email.split('@')[0];
            document.getElementById('registration-tile').classList.remove('opacity-40', 'pointer-events-none');
            document.getElementById('logout-btn').classList.remove('hidden');
            if(isDirector) { document.documentElement.classList.add('director-active'); document.getElementById('director-totality').classList.remove('hidden'); }
            else { document.getElementById('ticket-btn').classList.remove('hidden'); }
        }

        async function logoutOperative() { await db.auth.signOut(); location.reload(); }
        async function submitDelegate() {
            const alias = document.getElementById('delegate-alias').value;
            const { error } = await db.from('registrations').insert([{ user_id: currentOp.id, alias: alias }]);
            if(!error) alert("Registry Confirmed."); else alert("DB Error: Verify SQL tables.");
        }

        function generateEntryTicket() {
            const qrDiv = document.getElementById('ticket-qrcode'); qrDiv.innerHTML = '';
            new QRCode(qrDiv, { text: `MOG-S001-${currentOp.id.substring(0,8)}`, width: 180, height: 180 });
            document.getElementById('ticket-alias').innerText = `DELEGATE: ${currentOp.email.split('@')[0]}`;
            document.getElementById('ticket-portal').classList.remove('hidden');
        }

        function calcTax() { const g = parseFloat(document.getElementById('tax-gross').value) || 0; document.getElementById('tax-net').innerText = `R${(g * 0.85).toFixed(2)}`; }

        async function fetchMessages() {
            const { data } = await db.from('messages').select('*').order('created_at', { ascending: true });
            if (data) document.getElementById('chat-stream').innerHTML = data.map(m => `<div class="mog-bubble"><p class="text-[8px] text-blue-400 font-black">${m.alias}</p><p>${m.content}</p></div>`).join('');
        }

        window.onload = () => { 
            fetchMessages(); setInterval(fetchMessages, 10000);
            db.auth.getUser().then(({data}) => { if(data.user) { currentOp = data.user; syncClearance(currentOp.email === 'director.mog@gmail.com'); } });
        };
    </script>
</body>
</html>
